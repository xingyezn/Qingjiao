<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é’æ¤’ä¹‹æ¢¯ Â· é¡¹ç›®ç”³æŠ¥å¯¼èˆª</title>
<meta name="description" content="é¢å‘é«˜æ ¡é’å¹´æ•™å¸ˆçš„çºµå‘ç§‘ç ”é¡¹ç›®èµ„æ–™å¯¼èˆªï¼ŒåŒ…å«ç”³æŠ¥æ—¶é—´çº¿ã€å¯æœç´¢/ç­›é€‰æ¸…å•ã€æ”¶è—ä¸æ—¥å†å¯¼å‡ºã€‚" />
<link rel="icon" href="logo.png" />
<style>
  /* ===== ä¸»é¢˜å˜é‡ï¼ˆæ˜æš—ï¼‰ ===== */
  :root{
    --bg: #0b0f14;           /* æ·±è‰²èƒŒæ™¯ï¼Œå¤œç©º */
    --bg-soft:#111827;       /* å¡ç‰‡èƒŒæ™¯ */
    --text:#e5e7eb;          /* æ–‡å­— */
    --muted:#9ca3af;         /* æ¬¡çº§æ–‡å­— */
    --brand:#22c55e;         /* å“ç‰Œç»¿ */
    --brand-2:#60a5fa;       /* è¾…è‰²è“ */
    --accent:#f59e0b;        /* å¼ºè°ƒè‰²ï¼ˆè¿›åº¦æ¡ï¼‰ */
    --danger:#f87171;        /* ç´§æ€¥ */
    --ok:#34d399;            /* æ­£å¸¸ */
    --border:#1f2937;        /* è¾¹æ¡† */
    --chip:#0f172a;          /* ç­›é€‰ç­¹ */
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  [data-theme="light"]{
    --bg:#f6f7fb; --bg-soft:#ffffff; --text:#0f172a; --muted:#475569; --brand:#16a34a; --brand-2:#2563eb; --accent:#ea580c; --danger:#dc2626; --ok:#059669; --border:#e2e8f0; --chip:#f1f5f9; --shadow: 0 10px 30px rgba(2,6,23,.08);
  }

  /* ===== åŸºç¡€æ’ç‰ˆä¸å¸ƒå±€ ===== */
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--brand-2);text-decoration:none}
  a:hover{text-decoration:underline}
  img{max-width:100%;display:block}

  /* é¡¶éƒ¨å¯¼èˆªï¼ˆç»ç’ƒæ‹Ÿæ€ï¼‰ */
  header{
    position:sticky;top:0;z-index:40;border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(15,23,42,.75), rgba(15,23,42,.5));
    backdrop-filter:saturate(140%) blur(8px);
  }
  .nav{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:10px 16px}
  .nav .brand{display:flex;align-items:center;gap:10px}
  .nav .brand img{width:34px;height:34px;border-radius:10px}
  .nav .brand h1{margin:0;font-size:18px;letter-spacing:.5px}
  .nav .grow{flex:1}
  .nav .btn, .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--bg-soft);color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer;text-decoration:none}
  .btn:hover{box-shadow:var(--shadow)}

  /* è‹±é›„åŒº */
  .hero{position:relative;overflow:hidden}
  .hero-inner{max-width:1200px;margin:24px auto 0;padding:0 16px 24px}
  .glass{
    position:relative;border:1px solid var(--border);background:linear-gradient(135deg, rgba(34,197,94,.12), rgba(96,165,250,.12));
    border-radius:18px;padding:18px;box-shadow:var(--shadow)
  }
  .hero h2{margin:0 0 6px;font-size:22px}
  .hero p{margin:6px 0;color:var(--muted)}

  /* é¡¶éƒ¨å¿«æ·åŒº */
  .top-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

  /* ä¸»ä½“åŒºåŸŸ */
  main{max-width:1200px;margin:0 auto;padding:0 16px 60px}
  section{margin:26px 0}
  h3{margin:0 0 12px;font-size:20px}

  /* å¡ç‰‡ç½‘æ ¼ */
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid-3{grid-template-columns:2fr 1.5fr 1.5fr}}

  /* æ—¶é—´çº¿ï¼ˆæ­£åœ¨ç”³æŠ¥ï¼‰ */
  .timeline{display:grid;gap:14px}
  .item{border:1px solid var(--border);background:var(--bg-soft);border-radius:16px;padding:14px;display:grid;gap:8px}
  .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:12px;color:var(--muted)}
  .level-nat{background:linear-gradient(90deg, #65d877, #c4e276)}
  .level-prov{background:linear-gradient(90deg, #a7fff9, #a4bef6)}
  .title{display:flex;gap:10px;align-items:flex-start}
  .title a{font-weight:700;font-size:16px}
  .note{color:var(--muted)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}

  /* è¿›åº¦æ¡ï¼ˆè·æˆªæ­¢ï¼‰ */
  .bar{height:8px;background:rgba(148,163,184,.25);border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg, var(--brand), var(--accent));width:0%}
  .due{font-weight:600}
  .due-soon{color:var(--danger)}
  .due-open{color:var(--ok)}
  .due-past{color:var(--muted)}

  /* å·¥å…·æ¡ */
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
  .toolbar .search{flex:2;min-width:220px}
  input[type="search"], select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bg-soft);color:var(--text)}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip);cursor:pointer}
  .chip[aria-pressed="true"]{outline:2px solid var(--brand)}

  /* è¡¨æ ¼ï¼ˆå·²æ•´ç†ï¼‰ */
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border)}
  th{background:linear-gradient(180deg, rgba(148,163,184,.15), transparent);text-align:left;white-space:nowrap}
  tr:last-child td{border-bottom:none}

  /* é¡µè„š */
  footer{margin:26px 0;color:var(--muted);text-align:center}

  /* æµ®åŠ¨æŒ‰é’® */
  .fab{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:10px;z-index:50}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand">
      <img src="logo.png" alt="é’æ¤’ä¹‹æ¢¯ Logo" />
      <h1>é’æ¤’ä¹‹æ¢¯ Â· é¡¹ç›®ç”³æŠ¥å¯¼èˆª</h1>
    </div>
    <span class="grow"></span>
    <a class="btn" href="#ongoing">æ­£åœ¨ç”³æŠ¥</a>
    <a class="btn" href="#catalog">å·²æ•´ç†</a>
    <button id="themeToggle" class="btn" aria-label="åˆ‡æ¢æ˜æš—">ğŸŒ“ ä¸»é¢˜</button>
  </div>
</header>

<div class="hero">
  <div class="hero-inner">
    <div class="glass">
      <h2>çºµå‘é¡¹ç›®ï¼Œä¸€ç«™å¼æ—¶é—´çº¿ä¸èµ„æ–™åº“</h2>
      <p>ä¸ºé«˜æ ¡é’å¹´æ•™å¸ˆï¼ˆâ€œé’æ¤’â€ï¼‰è®¾è®¡çš„ç”³æŠ¥å¯¼èˆªï¼šçœ‹è¿›åº¦ã€æŸ¥æŒ‡å—ã€åšæ”¶è—ã€å¯¼æ—¥å†ã€‚</p>
      <div class="top-actions">
        <button class="btn" id="btnExportCSV">â¬‡ï¸ å¯¼å‡ºå½“å‰åˆ—è¡¨ CSV</button>
        <button class="btn" id="btnShowOnlyStar">â­ ä»…çœ‹æ”¶è—</button>
        <button class="btn" id="btnReset">ğŸ”„ é‡ç½®ç­›é€‰</button>
      </div>
    </div>
  </div>
</div>

<main>
  <!-- æ­£åœ¨ç”³æŠ¥ï¼šæ—¶é—´çº¿ + ç­›é€‰ -->
  <section id="ongoing">
    <h3>ğŸ‰ æ­£åœ¨ç”³æŠ¥</h3>
    <div class="toolbar">
      <input class="search" id="searchOngoing" type="search" placeholder="æœç´¢ï¼šåç§° / å¤‡æ³¨ / çº§åˆ«â€¦" />
      <select id="levelOngoing">
        <option value="">å…¨éƒ¨çº§åˆ«</option>
        <option value="å›½å®¶çº§">å›½å®¶çº§</option>
        <option value="çœéƒ¨çº§">çœéƒ¨çº§</option>
        <option value="çœéƒ¨çº§ä»¥ä¸Š">çœéƒ¨çº§ä»¥ä¸Š</option>
      </select>
      <div class="chips">
        <button class="chip" data-chip="soon">ä¸´è¿‘æˆªæ­¢</button>
        <button class="chip" data-chip="open">æœªåˆ°æœŸ</button>
        <button class="chip" data-chip="past">å·²æˆªæ­¢</button>
      </div>
      <select id="sortOngoing">
        <option value="end">æŒ‰æˆªæ­¢æ—¶é—´ï¼ˆè¿‘â†’è¿œï¼‰</option>
        <option value="start">æŒ‰å¼€å§‹æ—¶é—´ï¼ˆè¿‘â†’è¿œï¼‰</option>
        <option value="name">æŒ‰åç§°</option>
      </select>
    </div>

    <div id="timeline" class="timeline"></div>
  </section>

  <!-- å·²æ•´ç†ï¼šè¡¨æ ¼ -->
  <section id="catalog">
    <h3>ğŸ“š å·²æ•´ç†é¡¹ç›®ï¼ˆç‚¹å‡»åç§°ç›´è¾¾å®˜æ–¹æŒ‡å—ï¼‰</h3>
    <div class="toolbar">
      <input class="search" id="searchCatalog" type="search" placeholder="æœç´¢ï¼šåç§° / çº§åˆ« / éš¾åº¦â€¦" />
      <select id="levelCatalog">
        <option value="">å…¨éƒ¨çº§åˆ«</option>
        <option value="å›½å®¶çº§">å›½å®¶çº§</option>
        <option value="çœéƒ¨çº§">çœéƒ¨çº§</option>
        <option value="çœéƒ¨çº§ä»¥ä¸Š">çœéƒ¨çº§ä»¥ä¸Š</option>
      </select>
      <select id="sortCatalog">
        <option value="åºå·">æŒ‰åºå·</option>
        <option value="åç§°">æŒ‰åç§°</option>
        <option value="çº§åˆ«">æŒ‰çº§åˆ«</option>
      </select>
    </div>

    <div class="glass">
      <table id="catalogTable" aria-label="å·²æ•´ç†é¡¹ç›®æ¸…å•">
        <thead>
          <tr>
            <th>åºå·</th>
            <th>åç§°</th>
            <th>çº§åˆ«</th>
            <th>æäº¤æ—¥æœŸ</th>
            <th>éš¾åº¦</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- æ”»ç•¥ä¸è®¡åˆ’ -->
  <section>
    <h3>ğŸ§­ ä½¿ç”¨å°è´´å£«</h3>
    <div class="grid grid-4">
      <div class="glass">
        <strong>â‘  æ”¶è—ä¸åŒæ­¥</strong>
        <p class="note">ç‚¹å‡»å¡ç‰‡ä¸Šçš„ â­ å¯æ”¶è—ã€‚æ”¶è—ä¼šä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ã€‚</p>
      </div>
      <div class="glass">
        <strong>â‘¡ æ—¥å†ä¸€é”®å¯¼å‡º</strong>
        <p class="note">æ¯ä¸ªæ­£åœ¨ç”³æŠ¥é¡¹ç›®æ”¯æŒå¯¼å‡º <code>.ics</code>ï¼ŒåŠ å…¥ä½ å¸¸ç”¨çš„æ—¥å†ã€‚</p>
      </div>
      <div class="glass">
        <strong>â‘¢ æ˜æš—ä¸»é¢˜</strong>
        <p class="note">å³ä¸Šè§’ ğŸŒ“ åˆ‡æ¢ä¸»é¢˜ï¼Œè®°å¿†åœ¨æœ¬åœ°ã€‚</p>
      </div>
      <div class="glass">
        <strong>â‘£ è¯´æ˜</strong>
        <p class="note">é¡¹ç›®çº§åˆ«çš„åˆ¤å®šè¯·æ ¹æ®è‡ªå·±å­¦æ ¡çš„è§„å®šåˆ¤æ–­ã€‚é¡¹ç›®éš¾åº¦ä¸ºä¸ªäººä¼°è®¡ï¼Œä»…ä½œå‚è€ƒã€‚</p>
      </div>
    </div>
  </section>

  <footer>Â© <span id="year"></span> é’æ¤’ä¹‹æ¢¯ Â· Made with â¤ï¸ for é’å¹´æ•™å¸ˆ<br>
    GitHub åœ°å€: <a href="https://github.com/xingyezn/Qingjiao">https://github.com/xingyezn/Qingjiao</a>
    <br>
  å¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»ï¼šhxxu@shisu.edu.cn
  </footer>
</main>

<!-- æµ®åŠ¨æŒ‰é’® -->
<div class="fab">
  <a class="btn" href="#ongoing">â¬†ï¸ å›åˆ°æ­£åœ¨ç”³æŠ¥</a>
  <a class="btn" href="#catalog">ğŸ“š å»å·²æ•´ç†</a>
</div>

<script>
  // ===== ä¸»é¢˜æŒä¹…åŒ– =====
  (function(){
    const KEY='qjzt-theme';
    const saved = localStorage.getItem(KEY) || 'dark';
    if(saved==='light') document.documentElement.setAttribute('data-theme','light');
    document.getElementById('themeToggle').addEventListener('click',()=>{
      const cur = document.documentElement.getAttribute('data-theme')==='light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', cur==='light'?'light':'');
      localStorage.setItem(KEY, cur);
    });
  })();
  document.getElementById('year').textContent = new Date().getFullYear();

  // ===== æ•°æ®ï¼ˆæ¥è‡ªä½ çš„ Markdownï¼Œç¨ä½œç»“æ„åŒ–ï¼‰ =====
  const ongoingRaw = [
    { id:1, name:'åšå-é¢ä¸Š', url:'https://jj.chinapostdoctor.org.cn/auth/login.html?usertype=bsh', level:'å›½å®¶çº§', start:'2025-08-01', end:'2025-08-31', note:'æµåŠ¨ç«™æäº¤' },
    { id:2, name:'ä¸Šæµ·å¸‚å“²å­¦ç¤¾ä¼šç§‘å­¦è§„åˆ’', url:'https://www.sh-popss.gov.cn/newsInfo.asp?idval=8831&sessionid=1795235380', level:'çœéƒ¨çº§', start:'2025-08-15', end:'2025-08-25', note:'éœ€å•ä½ç»Ÿä¸€æäº¤' },
  ];

  const catalogRaw = [
    { åºå·:1, åç§°:'å›½å®¶è‡ªç„¶ç§‘å­¦åŸºé‡‘', é“¾æ¥:'https://www.nsfc.gov.cn/publish/portal0/xmzn/2025/qy/', çº§åˆ«:'å›½å®¶çº§', æäº¤æ—¥æœŸ:'3æœˆæäº¤ï¼Œ8æœˆå‡º', éš¾åº¦:'å›°éš¾' },
    { åºå·:2, åç§°:'å›½å®¶ç¤¾ä¼šç§‘å­¦åŸºé‡‘', é“¾æ¥:'http://www.nopss.gov.cn/n1/2025/0324/c431027-40445651.html', çº§åˆ«:'å›½å®¶çº§', æäº¤æ—¥æœŸ:'4æœˆä»½', éš¾åº¦:'å›°éš¾' },
    { åºå·:3, åç§°:'å…¨å›½æ•™è‚²ç§‘å­¦è§„åˆ’', é“¾æ¥:'https://onsgep.moe.edu.cn/post/view/1777', çº§åˆ«:'å›½å®¶çº§', æäº¤æ—¥æœŸ:'4.28-5.30ï¼Œ8æœˆå‡º', éš¾åº¦:'å›°éš¾' },
    { åºå·:4, åç§°:'æ•™è‚²éƒ¨äººæ–‡', é“¾æ¥:'http://www.moe.gov.cn/s78/A13/tongzhi/202502/t20250221_1179941.html', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'2-3æœˆ', éš¾åº¦:'è¾ƒéš¾' },
    { åºå·:5, åç§°:'ä¸Šæµ·å¸‚è‡ªç„¶ç§‘å­¦åŸºé‡‘', é“¾æ¥:'https://stcsm.sh.gov.cn/zwgk/kyjhxm/xmsb/20250126/86f5c86419764eaabca96179149fd742.html', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'2æœˆä»½', éš¾åº¦:'è¾ƒéš¾' },
    { åºå·:6, åç§°:'ä¸Šæµ·å¸‚å“²å­¦ç¤¾ä¼šç§‘å­¦è§„åˆ’', é“¾æ¥:'https://www.sh-popss.gov.cn/newsInfo.asp?idval=8831&sessionid=1795235380', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'8æœˆä»½', éš¾åº¦:'è¾ƒéš¾' },
    { åºå·:7, åç§°:'ä¸Šæµ·å¸‚æ•™å§”ç§‘ç ”åˆ›æ–°è®¡åˆ’é¡¹ç›®', é“¾æ¥:'https://kjc.shnu.edu.cn/aa/4c/c16762a764492/page.htm', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'', éš¾åº¦:'æœªçŸ¥' },
    { åºå·:8, åç§°:'ä¸Šæµ·å¸‚æ•™è‚²ç§‘å­¦ç ”ç©¶', é“¾æ¥:'https://hjy.hpe.cn/hygz/ggl/691452.htm', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'6æœˆä»½', éš¾åº¦:'ä¸€èˆ¬' },
    { åºå·:9, åç§°:'ä¸Šæµ·å¸‚è¶…çº§åšå', é“¾æ¥:'https://rsj.sh.gov.cn/trsrc_17739/20230803/t0035_1417472.html', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'9æœˆä»½', éš¾åº¦:'å›°éš¾' },
    { åºå·:10, åç§°:'åšå-é¢ä¸Š', é“¾æ¥:'https://jj.chinapostdoctor.org.cn/auth/login.html?usertype=bsh', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'3ã€8æœˆå¼€ï¼Œ6ã€11æœˆå‡º', éš¾åº¦:'è¾ƒéš¾' },
    { åºå·:11, åç§°:'åšå-BC æ¡£', é“¾æ¥:'https://jj.chinapostdoctor.org.cn/auth/login.html?usertype=bsh', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'3æœˆ', éš¾åº¦:'è¾ƒéš¾' },
    { åºå·:12, åç§°:'åšå-ç‰¹åˆ«èµ„åŠ©', é“¾æ¥:'https://jj.chinapostdoctor.org.cn/auth/login.html?usertype=bsh', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'3æœˆå¼€å§‹ï¼Œ6æœˆå‡º', éš¾åº¦:'æœªçŸ¥' },
    { åºå·:13, åç§°:'åšå-åšæ–°', é“¾æ¥:'https://jj.chinapostdoctor.org.cn/auth/login.html?usertype=bsh', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'ä¸BCæ¡£ä¸€èµ·', éš¾åº¦:'å¤§ä½¬ç‰¹ä¾›' },
     { åºå·:14, åç§°:'ä¸Šæµ·å¸‚è½¯ç§‘å­¦', é“¾æ¥:'https://stcsm.sh.gov.cn/zwgk/kyjhxm/xmsb/20250317/c1e6bf1406f14aa98e0363787c53d9d9.html', çº§åˆ«:'çœéƒ¨çº§', æäº¤æ—¥æœŸ:'3-4æœˆæäº¤', éš¾åº¦:'è¾ƒéš¾' },
  ];

  // ===== å·¥å…·å‡½æ•° =====
  const parseISO = (s)=>{ if(!s) return null; const m=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) return null; return new Date(+m[1], +m[2]-1, +m[3]); }
  const daysBetween = (a,b)=> Math.ceil((b - a)/(1000*60*60*24));
  const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));

  // æ”¶è—ï¼ˆæœ¬åœ°ï¼‰
  const STAR_KEY = 'qjzt-stars';
  const getStars = ()=> JSON.parse(localStorage.getItem(STAR_KEY) || '[]');
  const setStars = (ids)=> localStorage.setItem(STAR_KEY, JSON.stringify(ids));
  const toggleStar = (id)=> { const s=new Set(getStars()); s.has(id)?s.delete(id):s.add(id); setStars([...s]); };

  // ç”Ÿæˆ .ics æ–‡ä»¶
  function makeICS({title, start, end, url, note}){
    const dt = (d)=> d.replace(/-/g,'') + 'T090000';
    const uid = Date.now()+Math.random().toString(16).slice(2);
    const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//QJZT//Calendar Export//CN\nBEGIN:VEVENT\nUID:${uid}\nDTSTAMP:${dt(start)}Z\nDTSTART:${dt(start)}\nDTEND:${dt(end)}\nSUMMARY:${title}\nDESCRIPTION:${note||''} ${url||''}\nURL:${url||''}\nEND:VEVENT\nEND:VCALENDAR`;
    const blob=new Blob([ics],{type:'text/calendar'}); return URL.createObjectURL(blob);
  }

  // ===== æ¸²æŸ“ æ­£åœ¨ç”³æŠ¥ =====
  const timelineEl = document.getElementById('timeline');
  const searchOngoing = document.getElementById('searchOngoing');
  const levelOngoing = document.getElementById('levelOngoing');
  const sortOngoing = document.getElementById('sortOngoing');
  const chips = [...document.querySelectorAll('.chip')];
  let showOnlyStar = false;

  function statusOf(end){
    const now=new Date(); const d=parseISO(end);
    if(!d) return 'open';
    const left=daysBetween(now,d);
    if(left<0) return 'past';
    if(left<=10) return 'soon';
    return 'open';
  }

  function renderTimeline(){
    const stars=new Set(getStars());
    let list = ongoingRaw.map(x=> ({...x, _status:statusOf(x.end)}));

    // è¿‡æ»¤
    const q=searchOngoing.value.trim().toLowerCase();
    const lvl=levelOngoing.value;
    const activeChips = chips.filter(c=>c.getAttribute('aria-pressed')==='true').map(c=>c.dataset.chip);

    list = list.filter(r=>{
      const okQ = q ? (r.name.toLowerCase().includes(q) || (r.note||'').toLowerCase().includes(q) || r.level.includes(q)) : true;
      const okL = lvl ? r.level===lvl : true;
      const okC = activeChips.length? activeChips.includes(r._status) : true;
      const okS = showOnlyStar ? stars.has(r.id) : true;
      return okQ && okL && okC && okS;
    });

    // æ’åº
    const comparator = {
      end:(a,b)=>{ const da=parseISO(a.end), db=parseISO(b.end); return (da-db)||0; },
      start:(a,b)=>{ const da=parseISO(a.start), db=parseISO(b.start); return (da-db)||0; },
      name:(a,b)=> a.name.localeCompare(b.name,'zh-CN'),
    }[sortOngoing.value||'end'];
    list.sort(comparator);

    // æ¸²æŸ“
    timelineEl.innerHTML='';
    const now=new Date();
    list.forEach(r=>{
      const dEnd=parseISO(r.end); const left=dEnd?daysBetween(now,dEnd):null;
      const total=dEnd && parseISO(r.start) ? Math.max(1, daysBetween(parseISO(r.start), dEnd)) : 0;
      const passed=dEnd && parseISO(r.start) ? clamp(total - Math.max(0, left), 0, total) : 0;
      const pct = total? Math.round(passed/total*100) : 0;

      const item=document.createElement('div'); item.className='item';
      const title=document.createElement('div'); title.className='title';
      title.innerHTML = `
        <a href="${r.url}" target="_blank" rel="noopener">${r.name}</a>
        <span class="badge ${r.level.includes('å›½å®¶')?'level-nat':'level-prov'}">${r.level}</span>
        <button class="btn" data-star="${r.id}">${stars.has(r.id)?'â­ å·²æ”¶è—':'â˜† æ”¶è—'}</button>
        <a class="btn" href="#" data-ics='${r.id}'>ğŸ“† å¯¼å‡ºæ—¥å†</a>
      `;
      const meta=document.createElement('div'); meta.className='meta';
      const dueClass = left==null? 'due-open' : left<0? 'due-past' : left<=10? 'due-soon' : 'due-open';
      meta.innerHTML = `
        <span class="badge">å¼€å§‹ï¼š${r.start||'-'}</span>
        <span class="badge">æˆªæ­¢ï¼š<span class="due ${dueClass}">${r.end||'-'}${left==null?'': left>=0?`ï¼ˆå‰© ${left} å¤©ï¼‰`:'ï¼ˆå·²æˆªæ­¢ï¼‰'}</span></span>
        ${r.note?`<span class="badge">å¤‡æ³¨ï¼š${r.note}</span>`:''}
        <span class="badge">è¿›åº¦ï¼š${pct}%</span>
      `;

      const bar=document.createElement('div'); bar.className='bar';
      const span=document.createElement('span'); span.style.width=pct+'%'; bar.appendChild(span);

      item.appendChild(title); item.appendChild(meta); item.appendChild(bar);
      timelineEl.appendChild(item);
    });

    // ç»‘å®šæ”¶è—ä¸ ICS
    timelineEl.querySelectorAll('[data-star]').forEach(btn=>{
      btn.onclick = ()=>{ toggleStar(+btn.dataset.star); renderTimeline(); };
    });
    timelineEl.querySelectorAll('[data-ics]').forEach(a=>{
      a.onclick=(e)=>{
        e.preventDefault();
        const r = ongoingRaw.find(x=> x.id===+a.dataset.ics);
        const href = makeICS({title:r.name, start:r.start, end:r.end, url:r.url, note:r.note});
        a.href = href; a.download = `${r.name}.ics`; a.click();
        setTimeout(()=> URL.revokeObjectURL(href), 3000);
      };
    });
  }

  // UI äº¤äº’
  chips.forEach(c=> c.addEventListener('click',()=>{
    const on = c.getAttribute('aria-pressed')==='true';
    c.setAttribute('aria-pressed', on? 'false':'true');
    renderTimeline();
  }));
  [searchOngoing, levelOngoing, sortOngoing].forEach(el=> el.addEventListener('input', renderTimeline));
  document.getElementById('btnShowOnlyStar').addEventListener('click',()=>{ showOnlyStar=!showOnlyStar; renderTimeline(); });
  document.getElementById('btnReset').addEventListener('click',()=>{
    searchOngoing.value=''; levelOngoing.value=''; sortOngoing.value='end'; chips.forEach(c=>c.setAttribute('aria-pressed','false')); showOnlyStar=false; renderTimeline();
    document.getElementById('searchCatalog').value=''; document.getElementById('levelCatalog').value=''; document.getElementById('sortCatalog').value='åºå·'; renderCatalog();
  });

  // CSV å¯¼å‡ºï¼ˆåŸºäºå½“å‰è¿‡æ»¤åçš„æ—¶é—´çº¿ï¼‰
  document.getElementById('btnExportCSV').addEventListener('click',()=>{
    // ä¸´æ—¶æ¸²æŸ“ä¸€æ¬¡ä»¥è·å¾—è¿‡æ»¤åçš„ DOM
    renderTimeline();
    const rows = [...document.querySelectorAll('#timeline .item')].map(div=>{
      const name = div.querySelector('.title a')?.textContent.trim()||'';
      const level = div.querySelector('.badge')?.textContent.trim()||'';
      const meta = [...div.querySelectorAll('.meta .badge')].map(x=>x.textContent.replace(/\s+/g,' ').trim());
      return [name, level, ...meta];
    });
    const header=['åç§°','çº§åˆ«','å¼€å§‹','æˆªæ­¢','å¤‡æ³¨/çŠ¶æ€','è¿›åº¦'];
    const csv = [header, ...rows].map(r=> r.map(v=>`"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='æ­£åœ¨ç”³æŠ¥_ç­›é€‰å¯¼å‡º.csv'; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 2000);
  });

  // ===== æ¸²æŸ“ å·²æ•´ç† =====
  const catalogTable = document.getElementById('catalogTable');
  const searchCatalog = document.getElementById('searchCatalog');
  const levelCatalog = document.getElementById('levelCatalog');
  const sortCatalog = document.getElementById('sortCatalog');

  function renderCatalog(){
    const q = searchCatalog.value.trim().toLowerCase();
    const lvl = levelCatalog.value;
    let list = catalogRaw.filter(r=>{
      const okQ = q ? (r.åç§°.toLowerCase().includes(q) || r.çº§åˆ«.includes(q) || (r.éš¾åº¦||'').includes(q)) : true;
      const okL = lvl ? r.çº§åˆ«===lvl : true;
      return okQ && okL;
    });
    const key = sortCatalog.value;
    list.sort((a,b)=>{
      if(key==='åºå·') return (+a.åºå·)-(+b.åºå·);
      return String(a[key]||'').localeCompare(String(b[key]||''),'zh-CN');
    });

    const tbody = catalogTable.querySelector('tbody');
    tbody.innerHTML='';
    list.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.åºå·}</td>
        <td><a href="${r.é“¾æ¥}" target="_blank" rel="noopener">${r.åç§°}</a></td>
        <td>${r.çº§åˆ«}</td>
        <td>${r.æäº¤æ—¥æœŸ||''}</td>
        <td>${r.éš¾åº¦||''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  [searchCatalog, levelCatalog, sortCatalog].forEach(el=> el.addEventListener('input', renderCatalog));

  // åˆå§‹æ¸²æŸ“
  renderTimeline();
  renderCatalog();
</script>
</body>
</html>



